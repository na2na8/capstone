from selenium import webdriver
from bs4 import BeautifulSoup
import re
import csv
import math

#특수기호 제거, 언더바->스페이스, 곱하기 기호
def cleanText(readData):
    text = re.sub('[-=,./\\(\)\[\]\{\}<>?:~₩!@#$%^&●]', '', readData)
    text = text.replace("_", " ")
    text = text.replace("x", "*")
    text = text.replace("×", "*")
    return text

# 반올림
def _round(price) :
    rounded_price = round(float(price)/100)
    rounded_price = rounded_price*100
    return rounded_price

# #상품 명 중 '*' 뒤의  판별
# def delmul(readData):
#     i = readData.find('*')
#     return readData[:i]

# Chrome driver // 경로
driver = webdriver.Chrome('/Users/na2na/Downloads/chromedriver_win32/chromedriver')
# waiting web source loading 3 sec.
driver.implicitly_wait(3)

# basic url
url = "http://www.lottemart.com/category/categoryList.do?CategoryID="

# item 종류
# item = ["건강식품", "건강용품", "꿀류", "곡식", "견과류", "건과류", "선식", "차류", "두부", "채소", "과일", "정육", "계란", "생선", "버섯", "크랩류",
#     "오징어낙지", "기타해산물", "해초", "묵", "육포",]

# LOTTEMART CATEGORY_ID
# 건강차 항목 없어서 뺐음
# 건강용품 : 소화제 등, 마스크, 열팩, 족욕 등
# 기타해산물 : 새우, 조개 같은 거
# 유기농/친환경 Hav'eat쪽 카테고리 아직 안함 !!!!!!!!!!!@@@@@@@@@@@@@@2
# C001001200060004 : 양념류로 분류함(다진마늘, 완성된 식품 등))
lotte_category_id = {"C001014400010001" : "건강식품", "C001014400020003" : "건강식품", "C001014400020004" : "건강식품", 
    "C001014400020006" : "건강식품", "C001014500010001" : "건강식품", "C001014500010002" : "건강식품", "C001014500010003" : "건강식품", 
    "C001014500010004" : "건강식품", "C001014500020001" : "건강식품", "C001014500020002" : "건강식품", "C001014500020003" : "건강식품",
    "C001014500020004" : "건강식품", "C001014500020005" : "건강식품", "C001014500020007" : "건강식품", "C001014500020012" : "건강식품",
    "C001014500020016" : "건강식품", "C001014500030001" : "건강식품", "C001014500030002" : "건강식품", "C001014500030003" : "건강식품",
    "C001014500030004" : "건강식품", "C001014500040001" : "건강식품", "C001014500040002" : "건강식품", "C001014500040003" : "건강식품",
    "C001014500040004" : "건강식품", "C001014600010001" : "건강식품", "C001014600010002" : "건강식품", "C001014600020001" : "건강식품",
    "C001014700010001" : "건강식품", "C001014700010002" : "건강식품", "C001014700010003" : "건강식품", "C001014700010004" : "건강식품",
    "C001014700010005" : "건강식품", "C001014700020001" : "건강식품", "C001014700020002" : "건강식품", "C001014700020003" : "건강식품",
    "C001014700030002" : "건강식품", "C001014700030003" : "건강식품", "C001014700030004" : "건강식품", "C001014700030005" : "건강식품",
    "C001014700030006" : "건강식품", "C001014800010001" : "건강식품", "C001014800010004" : "건강식품", "C001014800020004" : "건강식품",
    "C001014800020006" : "건강식품", "C001014900010001" : "건강식품", "C001014900010002" : "건강식품", "C001014900010003" : "건강식품",
    "C001014900010004" : "건강식품", "C001014900020001" : "건강식품", "C001014900020002" : "건강식품", "C001014900020003" : "건강식품",
    "C001014900020004" : "건강식품", "C001014900030001" : "건강식품", "C00101500001" : "건강식품", "C00101500002" : "건강식품", 
    "C00101500003" : "건강식품", "C00101500004" : "건강식품", "C00101500005" : "건강식품", "C00101500006" : "건강식품",
    "C001015100010001" : "건강식품", "C001015100010002" : "건강식품", "C001015100010003" : "건강식품", "C001015100010004" : "건강식품",
    "C001015100010005" : "건강식품", "C001015100010006" : "건강식품", "C001015100010007" : "건강식품", "C001015100010008" : "건강식품",
    "C001015100010009" : "건강식품", "C001015100010010" : "건강식품", "C001015100010011" : "건강식품", "C001015100010012" : "건강식품",
    "C001015100010013" : "건강식품", "C001015100030001" : "꿀류", "C001015100030002" : "꿀류", "C001015100040001" : "건강식품", 
    "C001015100040002" : "건강식품", "C001015100040003" : "건강식품", "C001015100040004" : "건강식품", "C001015100040005" : "건강식품",
    "C001015100040006" : "건강식품", "C001015100040007" : "건강식품", "C001015100040008" : "건강식품", "C001015100040009" : "건강식품",
    "C001015100040010" : "건강식품", "C001015200010001" : "건강식품", "C001015200010002" : "건강식품", "C001015200010003" : "건강식품",
    "C001015200010004" : "건강식품", "C001015200010005" : "건강식품", "C001015200020002" : "건강식품", "C001015200020003" : "건강식품",
    "C001015200020005" : "건강식품", "C001015200030002" : "건강식품", "C001015200030003" : "건강식품", "C001015200030004" : "건강식품",
    "C001015200030005" : "건강식품", "C001015200030006" : "건강식품", "C001015200030007" : "건강식품", "C001015200030008" : "건강식품",
    "C001015200030009" : "건강식품", "C001015200030010" : "건강식품", "C001015200040001" : "건강식품", "C001015200040003" : "건강식품",
    "C001014300010001" : "건강용품", "C001014300010002" : "건강용품", "C001014300010003" : "건강용품", "C001014300010004" : "건강용품",
    "C001014300010005" : "건강용품", "C001014300010006" : "건강용품", "C001014300020001" : "건강용품", "C001014300020003" : "건강용품",
    "C001014300020004" : "건강용품", "C001014300020005" : "건강용품", "C001014300020006" : "건강용품", "C001014300030003" : "건강용품",
    "C001014300030004" : "건강용품", "C001014300040001" : "건강용품", "C001014300040002" : "건강용품", "C001014300040003" : "건강용품",
    # 친환경 해빗 카테고리 어떻게 처리할지 생각하기
    "C001001100030001" : "곡식", "C001001100070006" : "곡식", "C001001100070007" : "곡식", "C001001100010001" : "곡식",
    "C001001100010002" : "곡식", "C001001100010003" : "곡식", "C001001100010009" : "곡식", "C001001100020003" : "곡식",
    "C001001100020002" : "곡식", "C001001100020004" : "곡식", "C001001100020005" : "곡식", "C001001100050001" : "곡식",
    "C001001100050002" : "곡식", "C001001100050004" : "곡식", "C001001100050003" : "곡식", "C001001100060002" : "곡식",
    "C001001100060003" : "곡식", "C001001100060004" : "곡식", "C001001100060005" : "곡식", "C001001100060001" : "곡식",
    "C001004600010001" : "견과류", "C001004600010002" : "견과류", "C001004600010003" : "견과류", "C001004600010004" : "건과류",
    "C001004600010005" : "견과류", "C001004600010006" : "견과류", "C001004600020002" : "선식", "C001004600020001" : "선식",
    "C001004600030001" : "건강식품", "C001004600030002" : "차류", "C001004600030003" : "건강식품", "C001001200110001" : "두부",
    "C001001200110002" : "두부", "C001001200110003" : "두부", "C001001200110004" : "두부", "C001001200110007" : "소스",
    "C001001200110005" : "묵", "C001001200110006" : "채소", "C001001200010001" : "채소", "C001001200010002" : "채소", 
    "C001001200010004" : "채소", "C001001200080001" : "채소", "C001001200080002" : "채소", "C001001200030001" : "채소",
    "C001001200030002" : "채소", "C001001200030003" : "채소", "C001001200040001" : "채소", "C001001200040002" : "채소",
    "C001001200050001" : "채소", "C001001200050002" : "채소", "C001001200070001" : "채소", "C001001200070005" : "채소",
    "C001001200070004" : "해초", "C001001200070002" : "채소", "C001001200070003" : "채소", "C001001200060001" : "채소",
    "C001001200060002" : "채소", "C001001200060003" : "채소", "C001001200060004" : "양념", "C001001200090001" : "채소",
    "C001001200090002" : "채소", "C001001200090003" : "소스", "C001001200100001" : "버섯", "C001001200100002" : "버섯",
    "C001001200100003" : "버섯", "C001001200100004" : "버섯", "C001001200150002" : "채소", "C001001200150001" : "채소",
    "C001001200190001" : "채소", "C001001200190002" : "채소", "C001001300010001" : "과일", "C001001300010002" : "과일",
    "C001001300010003" : "과일", "C001001300020001" : "과일", "C001001300020002" : "과일", "C001001300030001" : "과일",
    "C001001300030002" : "과일", "C001001300030003" : "과일", "C001001300030004" : "과일", "C001001300040001" : "과일",
    "C001001300040002" : "과일", "C001001300040005" : "과일", "C001001300050001" : "과일", "C001001300050007" : "과일",
    "C001001300050008" : "과일", "C001001300150001" : "과일", "C001001300150002" : "과일", "C001001300150004" : "과일",
    "C001001300150005" : "과일", "C001001300150006" : "과일", "C001001300070001" : "과일", "C001001300070002" : "과일",
    "C001001300070004" : "과일", "C001001300080001" : "과일", "C001001300080003" : "과일", "C001001300160001" : "과일",
    "C001001300160002" : "과일", "C001001300160003" : "과일", "C001001300160004" : "과일", "C001001300170001" : "과일",
    "C001001300100001" : "과일", "C001001300100002" : "과일", "C001001300110001" : "과일", "C001001300110002" : "과일",
    "C001001300110003" : "과일", "C001001300110004" : "과일", "C001001300110005" : "과일", "C001001300110006" : "과일",
    "C001001300110007" : "견과류", "C001001400010001" : "정육", "C001001400010002" : "정육", "C001001400010003" : "정육",
    "C001001400010004" : "정육", "C001001400010005" : "정육", "C001001400010005" : "정육", "C001001400010008" : "정육", 
    "C001001400030003" : "정육", "C001001400030010" : "정육", "C001001400030004" : "정육", "C001001400030005" : "정육", 
    "C001001400030006" : "정육", "C001001400030008" : "정육", "C001001400030009" : "정육", "C001001400040001" : "정육",
    "C001001400040002" : "정육", "C001001400040003" : "정육", "C001001400040004" : "정육", "C001001400040005" : "정육",
    "C001001400040006" : "정육", "C001001400040007" : "정육", "C001001400040008" : "정육", "C001001400050001" : "정육",
    "C001001400050002" : "정육", "C001001400050003" : "정육", "C001001400050004" : "정육", "C001001400050005" : "정육",
    "C001001400060001" : "정육", "C001001400060002" : "정육", "C001001400060003" : "정육", "C001001400060004" : "정육",
    "C001001400060005" : "정육", "C001001400060006" : "정육", "C001001400060007" : "정육", "C001001400070001" : "계란",
    "C001001400070002" : "계란", "C001001400070003" : "계란", "C001001400070004" : "계란", "C001001400070005" : "계란",
    "C001001500010001" : "생선", "C001001500010002" : "생선", "C001001500010003" : "생선", "C001001500010007" : "생선",
    "C001001500010008" : "생선", "C001001500010009" : "생선", "C001001500010010" : "생선", "C001001500020001" : "생선",
    "C001001500020003" : "생선", "C001001500020008" : "생선", "C001001500020010" : "생선", "C001001500160001" : "크랩류",
    "C001001500160002" : "크랩류", "C001001500030001" : "오징어낙지", "C001001500030003" : "오징어낙지", "C001001500030004" : "기타해산물",
    "C001001500050001" : "기타해산물", "C001001500050003" : "기타해산물", "C001001500050004" : "기타해산물", "C001001500050005" : "기타해산물",
    "C001001500060001" : "생선", "C001001500060005" : "생선", "C001001500070011" : "생선", "C001001500070004" : "생선", 
    "C001001500070005" : "생선", "C001001500070008" : "기타해산물", "C001001500070009" : "조미료", "C001001500070010" : "생선",
    "C001001500100001" : "오징어낙지", "C001001500100002" : "오징어낙지", "C001001500100003" : "기타해산물", "C001001500100004" : "육포",
    "C001001500100006" : "오징어낙지", "C001001500080004" : "해초", "C001001500080006" : "해초", "C001001500080007" : "해초",
    "C001001500080008" : "해초", "C001001500080009" : "해초", "C001001500150002" : "생선", "C001001500150003" : "생선",
    "C001001500150004" : "기타해산물", "C001001500150005" : "생선", "C001001500150006" : "해초", "C001001500150009" : "생선", 
    "C001001500180001" : "해초", "C001001500180002" : "해초", "C001001500180003" : "해초", "C001001500180005" : "해초"} #치킨 * 초밥 * 베이커리 부터 다시...

# EMART CATEGORY_ID
# emart_category_id = {}

with open('lottemart.csv', 'w', encoding='UTF-8') as file:
    writer = csv.writer(file, delimiter=',')
    writer.writerow(['item', 'product', 'price', 'image'])

#우선 롯데마트만
for i in range(0, 21) :
    category_id = list(lotte_category_id.keys())[i]
    new_url = url + category_id
    driver.get(new_url)

    html = driver.page_source
    soup = BeautifulSoup(html, 'html.parser')

    # 마지막 페이지 찾기
    try :
        raw_page_info = soup.find("a", {"class" : "page-last"})
        page_info = int(raw_page_info["href"][66:])
    except TypeError as e :
        # 검색한 상품이 없을 경우 TypeError 예외처리
        pass
        
    
    
    
    for j in range(1, page_info+1) :
        new_url = url + category_id + "&currentPage=" + str(j)
        #롯데마트의 경우 class="wrap-prod-list"에 사진과 함께 제품명 들어있음.
        find_class = soup.find("div", {"class" : "wrap-prod-list"})
        product = find_class.find_all("img", {"width" : "208"})
        price = soup.find_all("span", {"class" : "num-n"})

        #csv로 저장    
        with open('lottemart.csv', 'a', encoding='UTF-8') as file:
            writer = csv.writer(file, delimiter=',')
            length = len(product)
            for k in range(0, length) :
                name = cleanText(product[k]["alt"]).upper()
#                 if '*' in name :
#                     name = delmul(name)
                img = product[k]["src"]
                price_ = price[k].text
                price_ = int(re.sub('[,]' , '', price_))
                price_ = _round(price_)
                
                category_num = list(lotte_category_id.values())[i]
                writer.writerow([category_num, name, price_, img])

# 저장된 파일 pd로 읽기
import pandas as pd
data = pd.read_csv('lottemart.csv')
data
    
